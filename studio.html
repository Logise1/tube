<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio - Tube</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #202020;
            color: #f1f1f1;
        }
    </style>
</head>

<body class="min-h-screen bg-[#181818]">

    <header class="bg-[#282828] shadow-md px-6 py-3 flex justify-between items-center h-16 fixed top-0 w-full z-10">
        <div class="flex items-center gap-2">
            <a href="index.html" class="text-red-600">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8">
                    <path
                        d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23c-.38.109-.766.248-1.14.406a1.859 1.859 0 0 0-.917 1.81c.213.67.436 1.345.678 2.019.239.664.49 1.334.755 2.001.266.666.538 1.336.815 2.001.05.122.105.235.165.341a2.312 2.312 0 0 1 1.818 1.521c.241.673.497 1.348.775 2.016.096.23.21.432.35.602a.965.965 0 0 0 .858.468c.373 0 .745-.083 1.11-.253.25-.11.498-.246.746-.395.27-.168.541-.334.811-.5.272-.167.545-.333.82-.497.054-.031.109-.06.163-.09.053.03.107.059.162.09.274.164.547.33.82.497.27.161.539.327.811.5.248.149.496.285.746.395-.365.17-.737.253-1.11.253-.336 0-.65.092-.936-.264.129-.08.235-.19.336-.316a2.64 2.64 0 0 0 .257-.384c.278-.668.533-1.343.774-2.016a2.31 2.31 0 0 1 1.818-1.521c.06-.106.115-.219.165-.341.277-.665.549-1.335.815-2.001.239-.665.49-.1349.728-2.019a1.859 1.859 0 0 0-.917-1.81c-.374-.158-.76-.297-1.14-.406a2.312 2.312 0 0 1-1.641-1.055c-.278-.668-.533-1.343-.774-2.016-.096-.23-.21-.432-.35-.602a.965.965 0 0 0-.858-.468c-.373 0-.745.083-1.11.253-.25.11-.498.246-.746.395-.27.168-.541.334-.811.5-.272.167-.545.333-.82.497-.054.031-.109.06.163-.09-.053.03-.107.059.162.09-.274.164-.547-.33-.82-.497-.27-.161-.539-.327-.811-.5-.248-.149-.496.285-.746.395-.365.17-.737.253-1.11.253-.336 0-.65.092-.936-.264.129-.08.235-.19.336-.316-.089.109-.164.237-.257.384z" />
                </svg>
            </a>
            <span class="text-xl font-bold tracking-tight">Studio</span>
        </div>
        <div id="user-info" class="text-sm text-gray-400">Verificando sesión...</div>
    </header>

    <main class="pt-24 px-4 flex justify-center">
        <div class="bg-[#282828] p-8 rounded-xl shadow-lg w-full max-w-2xl border border-gray-700">
            <h1 class="text-3xl font-bold mb-6 text-white pb-4 border-b border-gray-700">Subir Contenido</h1>

            <form id="upload-form" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Archivo de Video</label>
                        <input type="file" id="video-file" accept="video/*"
                            class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-600 file:text-white hover:file:bg-red-700 cursor-pointer bg-gray-900 rounded-lg border border-gray-600">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Miniatura</label>
                        <input type="file" id="thumbnail-file" accept="image/*"
                            class="block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-600 file:text-white hover:file:bg-red-700 cursor-pointer bg-gray-900 rounded-lg border border-gray-600">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Título</label>
                    <input type="text" id="video-title"
                        class="w-full p-3 rounded-lg bg-gray-900 border border-gray-600 text-white focus:border-red-500 focus:ring-1 focus:ring-red-500 outline-none placeholder-gray-500"
                        placeholder="Título atractivo...">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Descripción</label>
                    <textarea id="video-description" rows="4"
                        class="w-full p-3 rounded-lg bg-gray-900 border border-gray-600 text-white focus:border-red-500 focus:ring-1 focus:ring-red-500 outline-none placeholder-gray-500"
                        placeholder="Cuéntanos sobre tu video..."></textarea>
                </div>

                <div id="upload-status" class="text-center font-medium min-h-[20px]"></div>

                <div class="flex justify-end pt-4">
                    <button type="submit" id="submit-btn"
                        class="px-8 py-3 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                        PUBLICAR
                    </button>
                </div>
            </form>
        </div>
    </main>

    <script>
        const YYF_API_URL = 'https://yyf.mubilop.com/api/upload';
        const WORKER_VIDEO_URL = 'https://aritube.logise1123.workers.dev/api/videos/all';
        const CDN_BASE = 'https://yyf.mubilop.com';

        // Auth Check
        const token = localStorage.getItem('tubeclone_jwt_token');
        if (!token) window.location.href = 'login.html';

        try {
            // Basic UI update
            const payload = JSON.parse(atob(token.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')));
            document.getElementById('user-info').textContent = `Hola, ${payload.username}`;
        } catch (e) { window.location.href = 'login.html'; }


        async function uploadToYYF(file) {
            const fd = new FormData();
            fd.append('file', file, file.name);
            const res = await fetch(YYF_API_URL, { method: 'POST', body: fd });
            if (!res.ok) throw new Error('Fallo subida a storage');
            const data = await res.json();
            return CDN_BASE + data.fileUrl;
        }

        document.getElementById('upload-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const vFile = document.getElementById('video-file').files[0];
            const tFile = document.getElementById('thumbnail-file').files[0];
            const title = document.getElementById('video-title').value;
            const desc = document.getElementById('video-description').value;
            const status = document.getElementById('upload-status');
            const btn = document.getElementById('submit-btn');

            if (!vFile || !tFile || !title) return alert('Faltan campos');

            btn.disabled = true;
            status.className = 'text-blue-400';

            try {
                // 0. Check dimensions for Shorts tag
                status.textContent = 'Analizando video...';
                const isShort = await checkIsShort(vFile);

                status.textContent = 'Subiendo video (1/3)...';
                const vUrl = await uploadToYYF(vFile);

                status.textContent = 'Subiendo miniatura (2/3)...';
                const tUrl = await uploadToYYF(tFile);

                status.textContent = 'Guardando metadatos (3/3)...';
                const meta = {
                    title, description: desc, url: vUrl, thumbnail: tUrl,
                    duration: '0:30', views: 0,
                    isShort: isShort,
                    tags: isShort ? ['shorts'] : []
                };

                const res = await fetch(WORKER_VIDEO_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(meta)
                });

                if (!res.ok) throw new Error(await res.text());

                status.textContent = '¡Video Publicado!';
                status.className = 'text-green-400';
                setTimeout(() => window.location.href = 'index.html', 1500);

            } catch (err) {
                console.error(err);
                status.textContent = 'Error: ' + err.message;
                status.className = 'text-red-400';
                btn.disabled = false;
            }
        });

        // Helper to check video dimensions
        function checkIsShort(file) {
            return new Promise((resolve) => {
                const video = document.createElement('video');
                video.preload = 'metadata';
                video.onloadedmetadata = function () {
                    window.URL.revokeObjectURL(video.src);
                    // Standard definition of vertical video (or square)
                    const isVertical = video.videoHeight > video.videoWidth;
                    resolve(isVertical);
                };
                video.onerror = () => resolve(false); // Fallback
                video.src = URL.createObjectURL(file);
            });
        }
    </script>
</body>

</html>