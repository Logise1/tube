<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Estadísticas - Tube</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #0f0f0f;
            color: #f1f1f1;
        }
    </style>
</head>

<body class="overflow-x-hidden">

    <!-- Navbar -->
    <nav
        class="fixed top-0 w-full bg-[#0f0f0f] z-50 h-14 flex items-center justify-between px-4 lg:px-6 border-b border-[#222]">
        <div class="flex items-center gap-4">
            <a href="index.html" class="flex items-center gap-1">
                <span class="text-red-600">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8">
                        <path
                            d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23c-.38.109-.766.248-1.14.406a1.859 1.859 0 0 0-.917 1.81c.213.67.436 1.345.678 2.019.239.664.49 1.334.755 2.001.266.666.538 1.336.815 2.001.05.122.105.235.165.341a2.312 2.312 0 0 1 1.818 1.521c.241.673.497 1.348.775 2.016.096.23.21.432.35.602a.965.965 0 0 0 .858.468c.373 0 .745-.083 1.11-.253.25-.11.498-.246.746-.395.27-.168.541-.334.811-.5.272-.167.545.333-.82.497.054-.031.109-.06.163-.09.053.03.107.059.162.09.274.164.547.33.82.497.27.161.539.327.811.5.248.149.496.285.746.395-.365.17.737.253 1.11.253.336 0 .65-.092.936-.264.129-.08.235-.19.336-.316a2.64 2.64 0 0 0 .257-.384c.278-.668.533-1.343.774-2.016a2.31 2.31 0 0 1 1.818-1.521c.06-.106.115-.219.165-.341.277-.665.549-1.335.815-2.001.239-.665.49-.1349.728-2.019a1.859 1.859 0 0 0-.917-1.81c-.374-.158-.76-.297-1.14-.406a2.312 2.312 0 0 1-1.641-1.055c-.278-.668-.533-1.343-.774-2.016-.096-.23-.21-.432-.35-.602a.965.965 0 0 0-.858-.468c-.373 0-.745.083-1.11.253-.25.11-.498.246-.746.395-.27.168-.541.334-.811.5-.272.167-.545.333-.82.497-.054.031-.109.06.163-.09-.053.03-.107.059.162.09-.274.164-.547-.33-.82-.497-.27-.161-.539-.327-.811-.5-.248-.149-.496.285-.746.395-.365.17-.737.253-1.11.253-.336 0-.65.092-.936-.264.129-.08.235-.19.336-.316-.089.109-.164.237-.257.384z" />
                    </svg>
                </span>
                <span class="text-xl font-bold tracking-tight text-white hidden sm:block">Tube Studio</span>
            </a>
        </div>
        <div id="auth-section"></div>
    </nav>

    <div class="flex pt-14 h-screen">
        <!-- Sidebar -->
        <aside class="w-60 bg-[#0f0f0f] hidden md:flex flex-col h-full border-r border-[#222]">
            <div class="p-4">
                <div class="flex flex-col items-center mb-6">
                    <div id="sidebar-avatar"
                        class="w-20 h-20 rounded-full bg-purple-600 flex items-center justify-center text-3xl font-bold mb-3">
                        ?</div>
                    <h2 id="sidebar-name" class="font-bold text-sm">Tu Canal</h2>
                    <p class="text-xs text-gray-400">Panel de control</p>
                </div>
                <nav class="space-y-1">
                    <a href="#"
                        class="flex items-center gap-3 px-3 py-2 bg-[#272727] text-red-500 rounded-lg font-medium">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z">
                            </path>
                        </svg>
                        Estadísticas
                    </a>
                    <a href="studio.html"
                        class="flex items-center gap-3 px-3 py-2 text-gray-300 hover:bg-[#1f1f1f] rounded-lg transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                        </svg>
                        Subir Video
                    </a>
                    <a href="profile.html" id="public-link"
                        class="flex items-center gap-3 px-3 py-2 text-gray-300 hover:bg-[#1f1f1f] rounded-lg transition">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z">
                            </path>
                        </svg>
                        Ver Canal Público
                    </a>
                </nav>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-8 overflow-y-auto">
            <h1 class="text-2xl font-bold mb-6">Estadísticas del Canal</h1>

            <!-- KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Vistas Totales -->
                <div class="bg-[#1f1f1f] p-6 rounded-xl border border-[#333]">
                    <h3 class="text-gray-400 text-sm font-medium mb-1">Vistas Totales</h3>
                    <p class="text-3xl font-bold text-white" id="total-views">0</p>
                    <p class="text-xs text-gray-500 mt-2">En todos tus videos</p>
                </div>
                <!-- Suscriptores -->
                <div class="bg-[#1f1f1f] p-6 rounded-xl border border-[#333]">
                    <h3 class="text-gray-400 text-sm font-medium mb-1">Suscriptores</h3>
                    <p class="text-3xl font-bold text-white" id="total-subs">0</p>
                    <p class="text-green-500 text-xs mt-2 flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
                        </svg>
                        Audiencia actual
                    </p>
                </div>
                <!-- Videos -->
                <div class="bg-[#1f1f1f] p-6 rounded-xl border border-[#333]">
                    <h3 class="text-gray-400 text-sm font-medium mb-1">Videos Publicados</h3>
                    <p class="text-3xl font-bold text-white" id="video-count">0</p>
                    <p class="text-xs text-gray-500 mt-2">Contenido activo</p>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Video Performance List -->
                <div class="lg:col-span-2 bg-[#1f1f1f] rounded-xl border border-[#333] overflow-hidden">
                    <div class="p-4 border-b border-[#333]">
                        <h3 class="font-bold">Rendimiento de Videos Recientes</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-[#282828] text-gray-400">
                                <tr>
                                    <th class="p-4">Video</th>
                                    <th class="p-4">Vistas</th>
                                    <th class="p-4">Me gusta</th>
                                    <th class="p-4">Fecha</th>
                                </tr>
                            </thead>
                            <tbody id="videos-table-body" class="divide-y divide-[#333]">
                                <!-- Rows injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Mini Chart (Placeholder) -->
                <div class="bg-[#1f1f1f] p-6 rounded-xl border border-[#333]">
                    <h3 class="font-bold mb-4">Crecimiento</h3>
                    <div class="relative h-64 w-full">
                        <canvas id="growthChart"></canvas>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        const API_BASE = 'https://aritube.logise1123.workers.dev/api';
        const token = localStorage.getItem('tubeclone_jwt_token');

        if (!token) window.location.href = 'login.html';

        let currentUser = null;
        try {
            currentUser = JSON.parse(atob(token.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')));

            // Setup Sidebar Info
            document.getElementById('sidebar-name').textContent = currentUser.username;
            document.getElementById('sidebar-avatar').textContent = currentUser.username[0].toUpperCase();
            document.getElementById('public-link').href = `profile.html?u=${currentUser.userId}`;

            // Header Auth
            document.getElementById('auth-section').innerHTML = `
                <div class="w-8 h-8 rounded-full bg-purple-600 flex items-center justify-center font-bold text-white">
                    ${currentUser.username[0].toUpperCase()}
                </div>
            `;

        } catch (e) { window.location.href = 'login.html'; }

        async function loadStats() {
            try {
                // 1. Get User Profile for Subs
                const uRes = await fetch(`${API_BASE}/users/${currentUser.userId}`);
                const user = await uRes.json();
                document.getElementById('total-subs').textContent = user.subscribers || 0;

                // 2. Get User Videos
                const vRes = await fetch(`${API_BASE}/videos/user/${currentUser.userId}`);
                const videos = await vRes.json();

                if (Array.isArray(videos)) {
                    document.getElementById('video-count').textContent = videos.length;

                    // Stats calculation
                    const totalViews = videos.reduce((acc, v) => acc + (v.views || 0), 0);
                    document.getElementById('total-views').textContent = totalViews.toLocaleString();

                    // Table
                    const tbody = document.getElementById('videos-table-body');
                    if (videos.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">No hay videos aún</td></tr>';
                    } else {
                        // Sort by date desc
                        const sorted = videos.sort((a, b) => b.uploadDate - a.uploadDate);

                        tbody.innerHTML = sorted.slice(0, 10).map(v => `
                            <tr class="hover:bg-[#282828] transition">
                                <td class="p-4 flex gap-3 items-center">
                                    <img src="${v.thumbnail}" class="w-16 h-9 object-cover rounded bg-black">
                                    <span class="line-clamp-1 font-medium text-white max-w-[150px]">${v.title}</span>
                                </td>
                                <td class="p-4">${(v.views || 0).toLocaleString()}</td>
                                <td class="p-4">${(v.likes || 0).toLocaleString()}</td>
                                <td class="p-4 text-gray-400">${new Date(v.uploadDate).toLocaleDateString()}</td>
                            </tr>
                        `).join('');
                    }

                    renderChart(videos);
                }

            } catch (e) {
                console.error(e);
            }
        }

        function renderChart(videos) {
            // Fake chart data based on video upload sequence
            const ctx = document.getElementById('growthChart').getContext('2d');

            // Take last 5 videos for chart
            const lastVideos = videos.slice(0, 5).reverse();
            const labels = lastVideos.map((v, i) => `Vid ${i + 1}`);
            const data = lastVideos.map(v => v.views || 0);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.length ? labels : ['Inicio'],
                    datasets: [{
                        label: 'Vistas Recientes',
                        data: data.length ? data : [0],
                        borderColor: '#ef4444', // Red
                        tension: 0.4,
                        fill: true,
                        backgroundColor: 'rgba(239, 68, 68, 0.1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#333' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        loadStats();
    </script>
</body>

</html>