<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil - Tube</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #0f0f0f;
            color: #f1f1f1;
        }
    </style>
</head>

<body class="overflow-x-hidden">

    <!-- Navbar -->
    <nav
        class="fixed top-0 w-full bg-[#0f0f0f]/95 backdrop-blur-md z-50 h-14 flex items-center justify-between px-4 border-b border-[#222]">
        <div class="flex items-center gap-4">
            <a href="index.html" class="flex items-center gap-1">
                <span class="text-red-600">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-8 h-8">
                        <path
                            d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23c-.38.109-.766.248-1.14.406a1.859 1.859 0 0 0-.917 1.81c.213.67.436 1.345.678 2.019.239.664.49 1.334.755 2.001.266.666.538 1.336.815 2.001.05.122.105.235.165.341a2.312 2.312 0 0 1 1.818 1.521c.241.673.497 1.348.775 2.016.096.23.21.432.35.602a.965.965 0 0 0 .858.468c.373 0 .745-.083 1.11-.253.25-.11.498-.246.746-.395.27-.168.541-.334.811-.5.272-.167.545.333-.82.497.054-.031.109-.06.163-.09.053.03.107.059.162.09.274.164.547.33.82.497.27.161.539.327.811.5.248.149.496.285.746.395-.365.17.737.253 1.11.253.336 0 .65-.092.936-.264.129-.08.235-.19.336-.316a2.64 2.64 0 0 0 .257-.384c.278-.668.533-1.343.774-2.016a2.31 2.31 0 0 1 1.818-1.521c.06-.106.115-.219.165-.341.277-.665.549-1.335.815-2.001.239-.665.49-.1349.728-2.019a1.859 1.859 0 0 0-.917-1.81c-.374-.158-.76-.297-1.14-.406a2.312 2.312 0 0 1-1.641-1.055c-.278-.668-.533-1.343-.774-2.016-.096-.23-.21-.432-.35-.602a.965.965 0 0 0-.858-.468c-.373 0-.745.083-1.11.253-.25.11-.498.246-.746.395-.27.168-.541.334-.811.5-.272.167-.545.333-.82.497-.054.031-.109.06.163-.09-.053.03-.107.059.162.09-.274.164-.547-.33-.82-.497-.27-.161-.539-.327-.811-.5-.248-.149-.496.285-.746.395-.365.17-.737.253-1.11.253-.336 0-.65.092-.936-.264.129-.08.235-.19.336-.316-.089.109-.164.237-.257.384z" />
                    </svg>
                </span>
                <span class="text-xl font-bold text-white hidden sm:block">Tube</span>
            </a>
        </div>
        <div id="auth-check"></div>
    </nav>

    <!-- Header / Banner -->
    <div class="h-32 md:h-48 bg-gradient-to-r from-gray-800 to-gray-900 w-full mt-14"></div>

    <main class="max-w-6xl mx-auto px-4 sm:px-6 mb-10">
        <!-- Info del Canal -->
        <div class="flex flex-col sm:flex-row items-center sm:items-start gap-6 -mt-8 mb-8">
            <div class="w-24 h-24 sm:w-32 sm:h-32 rounded-full bg-purple-600 border-4 border-[#0f0f0f] flex items-center justify-center text-4xl font-bold text-white shadow-lg"
                id="avatar">
                ?
            </div>
            <div class="flex-1 text-center sm:text-left mt-2">
                <h1 class="text-3xl font-bold text-white mb-1" id="username">Cargando...</h1>
                <p class="text-gray-400 text-sm mb-4" id="subs-count">@usuario • 0 suscriptores • 0 videos</p>
                <div class="flex gap-2 justify-center sm:justify-start">
                    <button class="bg-white text-black px-6 py-2 rounded-full font-bold text-sm hover:bg-gray-200"
                        id="sub-btn">
                        Suscribirse
                    </button>
                    <button class="bg-[#272727] text-white px-6 py-2 rounded-full font-bold text-sm hover:bg-[#3f3f3f]">
                        Compartir
                    </button>
                </div>
            </div>
        </div>

        <!-- TABS -->
        <div class="border-b border-[#303030] mb-6 flex gap-8 text-sm font-medium text-gray-400 overflow-x-auto">
            <button class="pb-3 border-b-2 border-white text-white">VIDEOS</button>
            <button class="pb-3 border-b-2 border-transparent hover:text-white">SHORTS</button>
            <button class="pb-3 border-b-2 border-transparent hover:text-white">LISTAS</button>
            <button class="pb-3 border-b-2 border-transparent hover:text-white">COMUNIDAD</button>
        </div>

        <!-- VIDEO GRID -->
        <div id="video-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
            <!-- Videos inject here -->
        </div>

    </main>

    <script>
        const API_BASE = 'https://aritube.logise1123.workers.dev/api';
        const urlParams = new URLSearchParams(window.location.search);
        let targetUser = urlParams.get('u'); // ?u=username
        const token = localStorage.getItem('tubeclone_jwt_token');
        let myUser = null;

        if (token) {
            try {
                myUser = JSON.parse(atob(token.split('.')[1].replace(/-/g, '+').replace(/_/g, '/')));
                if (!targetUser) targetUser = myUser.userId; // Default to self
            } catch (e) { }
        }

        if (!targetUser) {
            window.location.href = 'index.html'; // No user to show
        }

        async function loadProfile() {
            try {
                // 1. Fetch User Info
                const res = await fetch(`${API_BASE}/users/${targetUser}`);
                if (!res.ok) throw new Error('Usuario no encontrado');
                const user = await res.json();

                document.getElementById('username').textContent = user.username;
                document.getElementById('avatar').textContent = user.username[0].toUpperCase();
                document.getElementById('subs-count').textContent = `@${user.username} • ${user.subscribers || 0} suscriptores`;

                // Sub Button Logic
                const subBtn = document.getElementById('sub-btn');
                if (myUser && myUser.userId === targetUser) {
                    subBtn.classList.add('hidden'); // No subscribe to self
                } else {
                    subBtn.onclick = async () => {
                        if (!myUser) return window.location.href = 'login.html';
                        subBtn.innerText = 'Suscrito';
                        subBtn.classList.replace('bg-white', 'bg-gray-700');
                        subBtn.classList.replace('text-black', 'text-white');
                        subBtn.disabled = true;

                        try {
                            const sRes = await fetch(`${API_BASE}/videos/subscribe/${targetUser}`, {
                                method: 'POST',
                                headers: { 'Authorization': `Bearer ${token}` }
                            });
                            if (!sRes.ok) throw new Error();
                        } catch (e) {
                            alert('Error al suscribirse');
                            subBtn.innerText = 'Suscribirse';
                            subBtn.disabled = false;
                            subBtn.classList.replace('bg-gray-700', 'bg-white');
                            subBtn.classList.replace('text-white', 'text-black');
                        }
                    };
                }

                // 2. Fetch User Videos
                loadUserVideos(targetUser);

            } catch (e) {
                document.body.innerHTML = `<h1 class="text-center mt-20 text-red-500">${e.message}</h1>`;
            }
        }

        async function loadUserVideos(userId) {
            try {
                const res = await fetch(`${API_BASE}/videos/user/${userId}`);
                const videos = await res.json();
                const grid = document.getElementById('video-grid');

                if (!videos.length) {
                    grid.innerHTML = '<p class="text-gray-400 col-span-full text-center py-10">Este canal no tiene videos.</p>';
                    return;
                }

                grid.innerHTML = videos.map(v => `
                    <div class="cursor-pointer group" onclick="window.location.href='watch.html?v=${v.id}'">
                        <div class="relative aspect-video bg-gray-800 rounded-xl overflow-hidden mb-2">
                             <img src="${v.thumbnail}" class="w-full h-full object-cover group-hover:scale-105 transition duration-300">
                             <span class="absolute bottom-1 right-1 bg-black/80 text-white text-xs px-1 rounded">${v.duration || '0:00'}</span>
                        </div>
                        <h3 class="font-bold text-white text-sm line-clamp-2 leading-tight group-hover:text-gray-300">${v.title}</h3>
                        <p class="text-xs text-gray-400 mt-1">${v.views || 0} vistas • hace poco</p>
                    </div>
                `).join('');

            } catch (e) { console.error(e); }
        }

        loadProfile();
    </script>
</body>

</html>